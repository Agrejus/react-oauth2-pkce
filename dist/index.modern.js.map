{"version":3,"file":"index.modern.js","sources":["../src/AuthContext.tsx","../src/AuthProvider.tsx","../src/pkce.ts","../src/util.ts","../src/AuthService.ts"],"sourcesContent":["import React, { useContext, ReactElement } from 'react'\r\n\r\nimport { AuthServiceProps, AuthService } from './AuthService'\r\n\r\nexport type AuthContextProps<T extends any> = {\r\n  authService: AuthService & T\r\n}\r\n\r\nexport type AuthContextType = AuthContextProps<any> | undefined\r\n\r\nexport const AuthContext = React.createContext<AuthContextProps<any> | undefined>(\r\n  undefined\r\n)\r\n\r\nexport const useAuth = <T extends any>(): AuthContextProps<T> => {\r\n  const context = useContext(AuthContext)\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within a AuthProvider')\r\n  }\r\n  return context\r\n}\r\n\r\nexport function withAuth<T>(\r\n  ComponentToWrap: React.ComponentType<T & AuthServiceProps>\r\n): React.FC<T & AuthServiceProps> {\r\n  const WrappedComponent = (props: T & AuthServiceProps): ReactElement => {\r\n    const authProps = useAuth()\r\n    return <ComponentToWrap {...authProps} {...props} />\r\n  }\r\n  WrappedComponent.displayName =\r\n    'withAuth_' + (ComponentToWrap.displayName || ComponentToWrap.name)\r\n  return WrappedComponent\r\n}\r\n","import React, { ReactElement, ReactNode } from 'react'\r\n\r\nimport { AuthService } from './AuthService'\r\nimport { AuthContext } from './AuthContext'\r\n\r\ninterface AuthProviderProps {\r\n  children: ReactNode\r\n  authService: AuthService\r\n}\r\n\r\nexport const AuthProvider = (props: AuthProviderProps): ReactElement => {\r\n  const { authService, children } = props\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ authService }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  )\r\n}\r\n","import { randomBytes, createHash } from 'crypto'\r\n\r\nexport type PKCECodePair = {\r\n  codeVerifier: string\r\n  codeChallenge: string\r\n  createdAt: Date\r\n}\r\n\r\nexport const base64URLEncode = (str: Buffer): string => {\r\n  return str\r\n    .toString('base64')\r\n    .replace(/\\+/g, '-')\r\n    .replace(/\\//g, '_')\r\n    .replace(/=/g, '')\r\n}\r\n\r\nexport const sha256 = (buffer: Buffer): Buffer => {\r\n  return createHash('sha256').update(buffer).digest()\r\n}\r\n\r\nexport const createPKCECodes = (): PKCECodePair => {\r\n  const codeVerifier = base64URLEncode(randomBytes(64))\r\n  const codeChallenge = base64URLEncode(sha256(Buffer.from(codeVerifier)))\r\n  const createdAt = new Date()\r\n  const codePair = {\r\n    codeVerifier,\r\n    codeChallenge,\r\n    createdAt\r\n  }\r\n  return codePair\r\n}\r\n","export const toSnakeCase = (str: string): string => {\r\n  return str\r\n    .split(/(?=[A-Z])/)\r\n    .join('_')\r\n    .toLowerCase()\r\n}\r\n\r\nexport const toUrlEncoded = (obj: {}): string => {\r\n  return Object.keys(obj)\r\n    .map(\r\n      (k) =>\r\n        encodeURIComponent(toSnakeCase(k)) + '=' + encodeURIComponent(obj[k])\r\n    )\r\n    .join('&')\r\n}\r\n","/* eslint-disable @typescript-eslint/camelcase */\r\nimport { createPKCECodes, PKCECodePair } from './pkce'\r\nimport { toUrlEncoded } from './util'\r\n\r\nimport jwtDecode from 'jwt-decode'\r\n\r\nexport interface AuthServiceProps {\r\n  clientId: string\r\n  clientSecret?: string\r\n  contentType?: string\r\n  location: Location\r\n  provider: string\r\n  authorizeEndpoint?: string\r\n  tokenEndpoint?: string\r\n  logoutEndpoint?: string\r\n  audience?: string\r\n  redirectUri?: string\r\n  scopes: string[]\r\n  autoRefresh?: boolean\r\n  refreshSlack?: number\r\n  onRedirectCallback?: (state?: string | null) => void;\r\n}\r\n\r\nexport interface AuthTokens {\r\n  id_token: string\r\n  access_token: string\r\n  refresh_token: string\r\n  expires_in: number\r\n  expires_at?: number // calculated on login\r\n  token_type: string\r\n}\r\n\r\nexport interface JWTIDToken {\r\n  given_name: string\r\n  family_name: string\r\n  name: string\r\n  email: string\r\n}\r\n\r\nexport interface TokenRequestBody {\r\n  clientId: string\r\n  grantType: string\r\n  redirectUri?: string\r\n  refresh_token?: string\r\n  clientSecret?: string\r\n  code?: string\r\n  codeVerifier?: string\r\n}\r\n\r\nexport interface AuthOptions {\r\n  state?: string;\r\n}\r\n\r\nexport class AuthService<TIDToken = JWTIDToken> {\r\n  props: AuthServiceProps\r\n  timeout?: number\r\n\r\n  constructor(props: AuthServiceProps) {\r\n    this.props = props\r\n    // const code = this.getCodeFromLocation(window.location)\r\n    // if (code !== null) {\r\n    //   this.fetchToken(code)\r\n    //     .then(() => {\r\n    //       this.restoreUri()\r\n    //     })\r\n    //     .catch((e) => {\r\n    //       this.removeItem('pkce')\r\n    //       this.removeItem('auth')\r\n    //       this.removeCodeFromLocation()\r\n    //       console.warn({ e })\r\n    //     })\r\n    // } else if (this.props.autoRefresh) {\r\n    //   this.startTimer()\r\n    // }\r\n\r\n    this.tryInvokeRedirectCallback();\r\n  }\r\n\r\n  private tryInvokeRedirectCallback() {\r\n\r\n    // ensure we only call redirect after successful authorization\r\n    const postAuthRedirect = window.localStorage.getItem('postAuthRedirect');\r\n    if (this.props.onRedirectCallback && postAuthRedirect && this.isAuthenticated() === true) {\r\n      const state = window.localStorage.getItem('postAuthState')\r\n      window.localStorage.removeItem('postAuthState')\r\n      window.localStorage.removeItem('postAuthRedirect')\r\n      this.props.onRedirectCallback(state)\r\n    }\r\n  }\r\n\r\n  getUser(): {} {\r\n    const t = this.getAuthTokens()\r\n    if (null === t) return {}\r\n    const decoded = jwtDecode(t.id_token) as TIDToken\r\n    return decoded\r\n  }\r\n\r\n  getCodeFromLocation(location: Location): string | null {\r\n    return this.getValueFromLocation(location, 'code');\r\n  }\r\n\r\n  getValueFromLocation(location: Location, name: string): string | null {\r\n    const split = location.toString().split('?')\r\n    if (split.length < 2) {\r\n      return null\r\n    }\r\n    const pairs = split[1].split('&')\r\n    for (const pair of pairs) {\r\n      const [key, value] = pair.split('=')\r\n      if (key === name) {\r\n        return decodeURIComponent(value || '')\r\n      }\r\n    }\r\n    return null\r\n  }\r\n\r\n\r\n  removeCodeFromLocation(): void {\r\n    const [base, search] = window.location.href.split('?')\r\n    if (!search) {\r\n      return\r\n    }\r\n    const newSearch = search\r\n      .split('&')\r\n      .map((param) => param.split('='))\r\n      .filter(([key]) => key !== 'code')\r\n      .map((keyAndVal) => keyAndVal.join('='))\r\n      .join('&')\r\n    window.history.replaceState(\r\n      window.history.state,\r\n      'null',\r\n      base + (newSearch.length ? `?${newSearch}` : '')\r\n    )\r\n  }\r\n\r\n  getItem(key: string): string | null {\r\n    return window.localStorage.getItem(key)\r\n  }\r\n  removeItem(key: string): void {\r\n    window.localStorage.removeItem(key)\r\n  }\r\n\r\n  getPkce(): PKCECodePair {\r\n    const pkce = window.localStorage.getItem('pkce')\r\n    if (null === pkce) {\r\n      throw new Error('PKCE pair not found in local storage')\r\n    } else {\r\n      return JSON.parse(pkce)\r\n    }\r\n  }\r\n\r\n  setAuthTokens(auth: AuthTokens): void {\r\n    const { refreshSlack = 5 } = this.props\r\n    const now = new Date().getTime()\r\n    auth.expires_at = now + (auth.expires_in + refreshSlack) * 1000\r\n    window.localStorage.setItem('auth', JSON.stringify(auth))\r\n  }\r\n\r\n  getAuthTokens(): AuthTokens {\r\n    return JSON.parse(window.localStorage.getItem('auth') || '{}')\r\n  }\r\n\r\n  isPending(): boolean {\r\n    return (\r\n      window.localStorage.getItem('pkce') !== null &&\r\n      window.localStorage.getItem('auth') === null\r\n    )\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return window.localStorage.getItem('auth') !== null\r\n  }\r\n\r\n  async logout(shouldEndSession: boolean = false): Promise<boolean> {\r\n    this.removeItem('pkce')\r\n    this.removeItem('auth')\r\n    if (shouldEndSession) {\r\n      const { clientId, provider, logoutEndpoint, redirectUri } = this.props;\r\n      const query = {\r\n        client_id: clientId,\r\n        post_logout_redirect_uri: redirectUri\r\n      }\r\n      const url = `${logoutEndpoint || `${provider}/logout`}?${toUrlEncoded(query)}`\r\n      window.location.replace(url)\r\n      return true;\r\n    } else {\r\n      window.location.reload()\r\n      return true\r\n    }\r\n  }\r\n\r\n  async login(options?: AuthOptions): Promise<void> {\r\n    this.authorize(options)\r\n  }\r\n\r\n  // this will do a full page reload and to to the OAuth2 provider's login page and then redirect back to redirectUri\r\n  authorize(options?: AuthOptions): boolean {\r\n\r\n    const url = this.buildAuthorizeUrl(options);\r\n    window.location.replace(url)\r\n    return true\r\n  }\r\n\r\n  buildAuthorizeUrl(options?: AuthOptions) {\r\n    const { clientId, provider, authorizeEndpoint, redirectUri, scopes, audience } = this.props\r\n\r\n    const pkce = createPKCECodes()\r\n    window.localStorage.setItem('pkce', JSON.stringify(pkce))\r\n    window.localStorage.setItem('preAuthUri', location.href)\r\n    window.localStorage.removeItem('auth')\r\n    const codeChallenge = pkce.codeChallenge\r\n\r\n    const query = {\r\n      clientId,\r\n      scope: scopes.join(' '),\r\n      responseType: 'code',\r\n      redirectUri,\r\n      ...(audience && { audience }),\r\n      codeChallenge,\r\n      codeChallengeMethod: 'S256',\r\n      ...(options && { ...options })\r\n    }\r\n\r\n    return `${authorizeEndpoint || `${provider}/authorize`}?${toUrlEncoded(query)}`\r\n  }\r\n\r\n  // this happens after a full page reload. Read the code from localstorage\r\n  async fetchToken(code: string, isRefresh = false): Promise<AuthTokens> {\r\n    const {\r\n      clientId,\r\n      clientSecret,\r\n      contentType,\r\n      provider,\r\n      tokenEndpoint,\r\n      redirectUri,\r\n      autoRefresh = true\r\n    } = this.props\r\n    const grantType = 'authorization_code'\r\n\r\n    let payload: TokenRequestBody = {\r\n      clientId,\r\n      ...(clientSecret ? { clientSecret } : {}),\r\n      redirectUri,\r\n      grantType\r\n    }\r\n    if (isRefresh) {\r\n      payload = {\r\n        ...payload,\r\n        grantType: 'refresh_token',\r\n        refresh_token: code\r\n      }\r\n    } else {\r\n      const pkce: PKCECodePair = this.getPkce()\r\n      const codeVerifier = pkce.codeVerifier\r\n      payload = {\r\n        ...payload,\r\n        code,\r\n        codeVerifier\r\n      }\r\n    }\r\n\r\n    const response = await fetch(`${tokenEndpoint || `${provider}/token`}`, {\r\n      headers: {\r\n        'Content-Type': contentType || 'application/x-www-form-urlencoded'\r\n      },\r\n      method: 'POST',\r\n      body: toUrlEncoded(payload)\r\n    })\r\n    this.removeItem('pkce')\r\n    const json = await response.json()\r\n    if (isRefresh && !json.refresh_token) {\r\n      json.refresh_token = payload.refresh_token\r\n    }\r\n\r\n    if ('error' in json) {\r\n      throw new Error(`Error: ${json.error},\\r\\nDescription: ${json.error_description}`)\r\n    }\r\n\r\n    this.setAuthTokens(json as AuthTokens)\r\n    if (autoRefresh) {\r\n      this.startTimer()\r\n    }\r\n    return this.getAuthTokens()\r\n  }\r\n\r\n  armRefreshTimer(refreshToken: string, timeoutDuration: number): void {\r\n    if (this.timeout) {\r\n      clearTimeout(this.timeout)\r\n    }\r\n    this.timeout = window.setTimeout(() => {\r\n      this.fetchToken(refreshToken, true)\r\n        .then(({ refresh_token: newRefreshToken, expires_at: expiresAt }) => {\r\n          if (!expiresAt) return\r\n          const now = new Date().getTime()\r\n          const timeout = expiresAt - now\r\n          if (timeout > 0) {\r\n            this.armRefreshTimer(newRefreshToken, timeout)\r\n          } else {\r\n            this.removeItem('auth')\r\n            this.removeCodeFromLocation()\r\n          }\r\n        })\r\n        .catch((e) => {\r\n          this.removeItem('auth')\r\n          this.removeCodeFromLocation()\r\n          console.warn({ e })\r\n        })\r\n    }, timeoutDuration)\r\n  }\r\n\r\n  startTimer(): void {\r\n    const authTokens = this.getAuthTokens()\r\n    if (!authTokens) {\r\n      return\r\n    }\r\n    const { refresh_token: refreshToken, expires_at: expiresAt } = authTokens\r\n    if (!expiresAt || !refreshToken) {\r\n      return\r\n    }\r\n    const now = new Date().getTime()\r\n    const timeout = expiresAt - now\r\n    if (timeout > 0) {\r\n      this.armRefreshTimer(refreshToken, timeout)\r\n    } else {\r\n      this.removeItem('auth')\r\n      this.removeCodeFromLocation()\r\n    }\r\n  }\r\n\r\n  restoreUri(): void {\r\n    const uri = window.localStorage.getItem('preAuthUri')\r\n    window.localStorage.removeItem('preAuthUri')\r\n    console.log({ uri })\r\n    if (uri !== null) {\r\n\r\n      const state = this.getValueFromLocation(location, 'state');\r\n      if (state) {\r\n        window.localStorage.setItem('postAuthState', state);\r\n      }\r\n\r\n      if (this.props.onRedirectCallback) {\r\n        window.localStorage.setItem('postAuthRedirect', \"true\");\r\n      }\r\n\r\n      window.location.replace(uri)\r\n    }\r\n    this.removeCodeFromLocation()\r\n  }\r\n}\r\n"],"names":["AuthContext","React","createContext","undefined","useAuth","context","useContext","Error","withAuth","ComponentToWrap","WrappedComponent","props","authProps","displayName","name","AuthProvider","authService","children","Provider","value","base64URLEncode","str","toString","replace","sha256","buffer","createHash","update","digest","createPKCECodes","codeVerifier","randomBytes","codeChallenge","Buffer","from","createdAt","Date","codePair","toSnakeCase","split","join","toLowerCase","toUrlEncoded","obj","Object","keys","map","k","encodeURIComponent","AuthService","tryInvokeRedirectCallback","postAuthRedirect","window","localStorage","getItem","onRedirectCallback","isAuthenticated","state","removeItem","getUser","t","getAuthTokens","decoded","jwtDecode","id_token","getCodeFromLocation","location","getValueFromLocation","length","pairs","pair","key","decodeURIComponent","removeCodeFromLocation","href","base","search","newSearch","param","filter","keyAndVal","history","replaceState","getPkce","pkce","JSON","parse","setAuthTokens","auth","refreshSlack","now","getTime","expires_at","expires_in","setItem","stringify","isPending","logout","shouldEndSession","clientId","provider","logoutEndpoint","redirectUri","query","client_id","post_logout_redirect_uri","url","reload","login","options","authorize","buildAuthorizeUrl","authorizeEndpoint","scopes","audience","scope","responseType","codeChallengeMethod","fetchToken","code","isRefresh","clientSecret","contentType","tokenEndpoint","autoRefresh","grantType","payload","refresh_token","fetch","headers","method","body","response","json","error","error_description","startTimer","armRefreshTimer","refreshToken","timeoutDuration","timeout","clearTimeout","setTimeout","then","newRefreshToken","expiresAt","e","console","warn","authTokens","restoreUri","uri","log"],"mappings":"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"}